---
- defaults:
    link:
      relink: true
    create:
      mode: 0755
    shell:
      stdin: true
      stdout: true
      stderr: true

- shell:
  - xcode-select --install || true
  - sudo softwareupdate --install-rosetta || true
  - /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  - sudo spctl --master-disable
  - export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:${PATH}" && brew bundle install
  - sudo spctl --master-enable

- create:
  - ~/Workspace
  - ~/.config
  - ~/.local/bin
  - ~/Library/Application Support/iTerm2

- create:
    ~/.ssh:
      mode: 0700
    ~/.ssh/keys:
      mode: 0700

- link:
    ~/.config/starship.toml: starship/starship.toml
    ~/.dive.yaml:
    ~/.gitignore:
    ~/.gitconfig:
    ~/.gitconfig-tencent:
    ~/.ssh/conf.d: ssh/conf.d
    ~/.ssh/config: ssh/config
    ~/.zshrc:
    ~/.zsh:
      force: true
    ~/Library/Application Support/iTerm2/DynamicProfiles:
      path: iterm2/DynamicProfiles
      force: true
    ~/Library/Application Support/iTerm2/shell_integration.zsh:
      path: iterm2/shell_integration.zsh

- shell:
  - command: |
      local email
      printf 'Email address used to log into 1password: '
      read email

      op signin my.1password.com "$email"
    description: Log into 1Password.
    quiet: true

  - |
    scripts/sshkeys.zsh \
      personal:ubckouhr3vd4njzutpc3k64la4:otdk3omgpbatxkq4ultfxghyui \
      tencent:7rh4f2nyvfg3hpxn53qxun6jke:ye3wb6dg7ja3bpbkfg4hv354ny

- shell:
  - defaults write com.apple.Finder FXPreferredViewStyle clmv
  - defaults write com.apple.finder _FXSortFoldersFirst -bool true
  - defaults write com.apple.finder FXDefaultSearchScope SCcf
  - defaults write com.apple.dock minimize-to-application -bool true
  - defaults write com.apple.dock tilesize -float 33
  - defaults write com.apple.dock magnification -bool true
  - defaults write com.apple.dock largesize -float 60
  - defaults write com.apple.dock minimize-to-application -bool true
  - defaults write com.apple.dock autohide -bool true
  - defaults write com.apple.dock show-recents -bool false
  - defaults write com.apple.menuextra.clock DateFormat "EEE MMM d  H:mm:ss"
  - defaults write com.apple.menuextra.clock IsAnalog -bool false
  - defaults write com.apple.menuextra.battery ShowPercent YES
  - /usr/libexec/PlistBuddy -c 'Set :StandardViewOptions:ColumnViewOptions:FontSize 12' ~/Library/Preferences/com.apple.finder.plist
  - defaults write -g com.apple.swipescrolldirection -bool false
  - osacompile -o '/Applications/Color Picker.app' -e 'choose color'  # TODO Add an icon.
  - killall Finder
  - killall Dock

- shell:
  - |
    cd ~/.local/bin
    wget -O- https://github.com/envkey/envkey-source/releases/download/v1.2.10/envkey-source_1.2.10_darwin_arm64.tar.gz | tar -zxf - envkey-source
    wget -O- https://github.com/envkey/envkey-fetch/releases/download/v1.2.9/envkey-fetch_1.2.9_darwin_arm64.tar.gz | tar -zxf - envkey-fetch
    chmod +x envkey-*